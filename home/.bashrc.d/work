[[ $- = *i* ]] || return
${IS_OSX} || return
${HEALTHY_INTERNET} || return

# TODO: move most of this to a script called after login or screen-unlock
#  https://stackoverflow.com/questions/6442364/running-script-upon-login-mac

# get network awareness
ip_address=""
at_work="false"
at_home="false"
on_vpn="false"

# grab all ip addresses
ip_address=$(/sbin/ifconfig 2> /dev/null | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}')

# figure out location
if [[ ${ip_address} =~ ${CUSTOM_WORK_SUBNET}.*.* ]]; then
  at_work="true"
elif [[ ${ip_address} =~ ${CUSTOM_VPN_SUBNET}.* ]]; then
  on_vpn="true"
elif [[ ${ip_address} =~ ${CUSTOM_HOME_SUBNET}* ]]; then
  at_home="true"
else
  echo "Could not determine location from ip_address ${ip_address}."
fi

function work_vpn {
  lpass show --password --clip "${CUSTOM_WORK_DOMAINS[0]/.com/} main (one login)"
  openit "Endpoint Security VPN"
}
if ${at_home} ; then
  # prompt for vpn connection to work
  if ! $(ping -c1 -W1 -i0.1 chef.${CUSTOM_WORK_DOMAINS[1]} &> /dev/null); then
    read -t 1 -s -p "To connect to work VPN, press Enter key within 1 second..." && work_vpn
    echo
  fi
  if $(ping -c1 -W1 -i0.1 ${CUSTOM_NAS_HOST} &> /dev/null) ; then
    mount | grep -q "Documents/share1" || mount -t nfs -o \
      vers=4,rw,soft,intr,bg,rwsize=32768,dsize=32768 \
      ${CUSTOM_NAS_HOST}:/share ~/Documents/share1
    mount | grep -q "Pictures/share1" || mount -t nfs -o \
      vers=4,rw,soft,intr,bg,rwsize=32768,dsize=32768 \
      ${CUSTOM_NAS_HOST}:/share/pictures ~/Pictures/share1
    openit "Backup and Sync"
  fi
elif ${at_work} ; then
  # disconnect any VPN connection
  if pgrep -f "Endpoint_Security_VPN"; then
    echo "Your VPN client is running at work, silly. Trying to shut it down..."
    pkill -f "Endpoint_Security_VPN" || echo "Unable to shutdown VPN client"
  fi
  _create_socks_proxy "home.${CUSTOM_HOME_DOMAIN}" "2000"

  while $(mount | grep -q "Documents/share1") ; do
    sudo umount -fv -t nfs ${CUSTOM_NAS_HOST}:/share
  done
  while $(mount | grep -q "Pictures/share1") ; do
    sudo umount -fv -t nfs ${CUSTOM_NAS_HOST}:/share/pictures
  done

  # open desktop apps (TODO: --background not working for Slack and Atom)
  openit Slack "Visual Studio Code"
elif ${on_vpn} ; then
  while $(mount | grep -q "Documents/share1") ; do
    sudo umount -fv -t nfs ${CUSTOM_NAS_HOST}:/share
  done
  while $(mount | grep -q "Pictures/share1") ; do
    sudo umount -fv -t nfs ${CUSTOM_NAS_HOST}:/share/pictures
  done
  return
  # establish SSH tunnel to home proxy
  lpass show --password --clip "proxy.${CUSTOM_NAS_HOST#*\.}"
  # TODO: curl gets "000" response code when on VPN
  # _create_socks_proxy "home.${CUSTOM_HOME_DOMAIN}" "2000"
else
  echo
  if ! $(ping -c1 -W1 -i0.1 chef-server.i.${CUSTOM_WORK_DOMAINS[0]} &> /dev/null); then
    (read -t 3 -s -p "Not at home or work; to connect to work VPN, press Enter within 3 seconds..." \
        && work_vpn)
  fi
  # read -t 2 -p "If in public location and need P.I.A. VPN, press Enter key within 2 seconds..." \
    # && nohup ~/.pia_manager/pia_manager.app/Contents/MacOS/runner.sh >/dev/null 2>&1 &
    # && openit "Private Internet Access"
  echo
fi
