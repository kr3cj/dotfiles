[[ $- = *i* ]] || return
${IS_OSX} || return
${HEALTHY_INTERNET} || return

# TODO: move most of this to a script called after login or screen-unlock
#  https://stackoverflow.com/questions/6442364/running-script-upon-login-mac

# get network awareness
ip_address=""
at_work="false"
at_home="false"

# grab all ip addresses
ip_address=$(/sbin/ifconfig 2> /dev/null | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}')

# figure out location
if [[ ${ip_address} =~ ${CUSTOM_WORK_SUBNET}.*.* ]]; then
  at_work="true"
elif [[ ${ip_address} =~ ${CUSTOM_HOME_SUBNET}* ]]; then
  at_home="true"
else
  echo "Could not determine location from ip_address ${ip_address}."
fi

function on_vpn {
  if [[ ${ip_address} =~ ${CUSTOM_VPN_SUBNET}.* ]]; then
    # ping -c1 -W1 -i0.1 tools.${CUSTOM_WORK_DOMAINS[0]} &> /dev/null
    # local response=$(curl https://${CUSTOM_WORK_K8S_DOMAIN}/version?timeout=2s \
    #   --insecure \
    #   --silent \
    #   --show-error \
    #   --write-out "%{http_code}" \
    #   --output /dev/null \
    #   --connect-timeout 2 \
    #   --max-time 5)
    # if [[ ${response} -eq 200 ]]; then
    return $(port ${CUSTOM_WORK_K8S_DOMAIN}:443 >/dev/null)
  else
    return false
  fi
}

function unmount_nfs {
  while $(mount | grep -q "Documents/share1") ; do
    sudo umount -fv -t nfs ${CUSTOM_NAS_HOST}:/share
  done
  while $(mount | grep -q "Pictures/share1") ; do
    sudo umount -fv -t nfs ${CUSTOM_NAS_HOST}:/share/pictures
  done
}
function mount_nfs {
    mount | grep -q "Documents/share1" || mount -t nfs -o \
      vers=4,rw,soft,intr,bg,rwsize=32768,dsize=32768 \
      ${CUSTOM_NAS_HOST}:/share ~/Documents/share1
    mount | grep -q "Pictures/share1" || mount -t nfs -o \
      vers=4,rw,soft,intr,bg,rwsize=32768,dsize=32768 \
      ${CUSTOM_NAS_HOST}:/share/pictures ~/Pictures/share1
}
function work_vpn {
  openit "Endpoint Security VPN"
  lpass show --password --clip "${CUSTOM_WORK_DOMAINS[0]/.com/} OneLogin" || echo "Unable to cache OneLogin pw."
}
function work_saml2aws {
  saml2aws login # outputs "credentials are not expired skipping" when auth'd
}
if ${at_home}; then
  # prompt for vpn connection to work

  if $(ping -c1 -W1 -i0.1 ${CUSTOM_NAS_HOST} &> /dev/null); then
    mount_nfs
    openit "Backup and Sync"
  fi
elif ${at_work}; then
  work_saml2aws
  _create_socks_proxy "home.${CUSTOM_HOME_DOMAIN}" "2000"

  unmount_nfs
  # open desktop apps (TODO: --background not working for Slack and Atom)
  # openit Slack "Visual Studio Code"

  # work dropped tunnel to aws, need to be on vpn all the time now :(
  if ! $(on_vpn); then
    read -t 5 -s -p "You must connect to work VPN! Press Enter to launch the dashboard icon." \
      && work_vpn
    echo
  fi
else
  unmount_nfs
  if ! $(on_vpn); then
    read -t 2 -s -p "Not at home or work; to connect to work VPN, press Enter within 2 seconds..." \
      && work_vpn
    echo
  fi
  # # establish SSH tunnel to home proxy
  # lpass show --password --clip "proxy.${CUSTOM_NAS_HOST#*\.}"
  # _create_socks_proxy "home.${CUSTOM_HOME_DOMAIN}" "2000"
fi
# if [[ $(on_vpn) ]]; then
#   unmount_nfs
#   ${at_work} || work_saml2aws
#   return
# fi
