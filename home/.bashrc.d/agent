[[ $- = *i* ]] || return
${IS_OSX} || return

# ssh agent stuff
[[ -f ${HOME}/.ssh/ssh-agent-setup ]] && source ${HOME}/.ssh/ssh-agent-setup
$(env | grep -q SSH_AUTH_SOCK) || eval $(ssh-agent -s)

### load ssh keys into agent ###
# TODO: better integrate passphrase from LastPass CLI? https://svkt.org/~simias/lpass/#ssh-agent
# temporarily load ssh keys from lastpass into agent
for key2 in "" _personal; do
  if ! $(ssh-add -l | grep -q "/.ssh/id_rsa${key2}\ ("); then
    key_desc="Work"
    [[ ${key2} == "_personal" ]] && key_desc="Personal"
    # create key if necessary
    (umask 177
    lpass show --field="Private Key" "${key_desc} SSH Key" > ~/.ssh/id_rsa${key2}
    )
    lpass show --field=Passphrase --clip "${key_desc} SSH Key"
    ssh-add -t 36000 -k ~/.ssh/id_rsa${key2}
    clear_clip
    rm -f ~/.ssh/id_rsa${key2}
  fi
done

# temporarily load ssh keys from vault into agent
for key3 in jenkins-builder coreos ; do
  if ! $(ssh-add -l | grep -q "/.ssh/id_rsa_${key3}\ (" ); then
    (umask 177
    vault read -field=private-key secret/ssh-keys/${key3} > ~/.ssh/id_rsa_${key3}
    )
    ssh-add -t 36000 -k ~/.ssh/id_rsa_${key3}
    rm -f ~/.ssh/id_rsa_${key3}
    # TODO: ssh-agent can load keys without a file
    # but they cant be referenced with "ssh -i <key_path>":
    # ssh-add - <<< $(vault read -field=private-key secret/ssh-keys/blah)
  fi
done
